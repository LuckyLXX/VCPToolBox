# VCPTavern 预设插件选项说明

## 概述

VCPTavern 是一个强大的、可视化的上下文注入插件，类似于 SillyTavern 的高级上下文编辑功能。它允许用户通过预设配置来自定义消息处理逻辑，实现智能的上下文注入。

## 预设结构

每个预设都是一个 JSON 文件，包含以下基本结构：

```json
{
    "name": "预设名称",
    "description": "预设描述",
    "rules": [
        // 注入规则数组
    ]
}
```

## 注入规则 (Rules)

每条注入规则包含以下属性：

### 基础属性

- `id`: 规则的唯一标识符
- `name`: 规则的显示名称
- `enabled`: 是否启用该规则 (true/false)
- `type`: 注入类型 ("relative" 或 "depth")

### 相对注入 (Relative Injection)

**类型**: `relative`

相对注入允许在特定位置（相对于系统消息或最后一个用户消息）插入内容。

#### 选项

- **position** (位置):
  - `before`: 在目标消息之前插入
  - `after`: 在目标消息之后插入

- **target** (目标):
  - `system`: 相对于系统消息进行注入
  - `last_user`: 相对于最后一个用户消息进行注入

- **content** (内容):
  消息对象，包含：
  - `role`: 消息角色 ("system", "user", "assistant")
  - `content`: 消息内容 (字符串)

#### 使用示例

```json
{
    "id": "system-boost",
    "name": "系统提示增强",
    "enabled": true,
    "type": "relative",
    "position": "after",
    "target": "system",
    "content": {
        "role": "system",
        "content": "你现在要更详细地回答用户的问题。"
    }
}
```

### 深度注入 (Depth Injection)

**类型**: `depth`

深度注入允许在对话历史的特定深度位置插入内容。

#### 选项

- **depth** (深度):
  - 数字值，表示从对话末尾向前数的消息位置
  - 深度为 1 表示在最后一条消息之前插入
  - 深度为 2 表示在倒数第二条消息之前插入
  - 以此类推

- **content** (内容):
  消息对象，包含：
  - `role`: 消息角色 ("system", "user", "assistant")
  - `content`: 消息内容 (字符串)

#### 使用示例

```json
{
    "id": "memory-reminder",
    "name": "记忆提醒",
    "enabled": true,
    "type": "depth",
    "depth": 3,
    "content": {
        "role": "system",
        "content": "请记住之前的对话内容，保持一致性。"
    }
}
```

## 触发机制

### 使用方法

在系统消息中添加触发器来激活预设：

```
{{VCPTavern::预设名称}}
```

例如：
```
{{VCPTavern::创意写作助手}} 你好，请帮我写一个科幻故事。
```

### 处理逻辑

1. 系统检测到触发器 `{{VCPTavern::预设名称}}`
2. 加载对应的预设配置
3. 按照规则进行上下文注入：
   - 先处理相对注入规则（按位置排序）
   - 再处理深度注入规则（按深度降序排序）
4. 返回注入后的完整消息列表

## 预设选项组合示例

### 1. 角色扮演增强预设

```json
{
    "name": "角色扮演助手",
    "description": "增强AI的角色扮演能力",
    "rules": [
        {
            "id": "role-persona",
            "name": "角色人格设定",
            "enabled": true,
            "type": "relative",
            "position": "after",
            "target": "system",
            "content": {
                "role": "system",
                "content": "你正在进行角色扮演，请保持角色的一致性和生动性，使用第一人称叙述。"
            }
        },
        {
            "id": "interaction-style",
            "name": "互动风格",
            "enabled": true,
            "type": "depth",
            "depth": 2,
            "content": {
                "role": "system",
                "content": "在对话中主动推进情节，提出问题来引导用户参与。"
            }
        }
    ]
}
```

### 2. 代码审查助手预设

```json
{
    "name": "代码审查专家",
    "description": "专业的代码审查和优化建议",
    "rules": [
        {
            "id": "review-criteria",
            "name": "审查标准",
            "enabled": true,
            "type": "relative",
            "position": "after",
            "target": "system",
            "content": {
                "role": "system",
                "content": "你是一位资深的代码审查专家，请从代码质量、安全性、性能和可维护性等方面进行评估。"
            }
        },
        {
            "id": "detailed-feedback",
            "name": "详细反馈",
            "enabled": true,
            "type": "relative",
            "position": "before",
            "target": "last_user",
            "content": {
                "role": "system",
                "content": "请提供具体的改进建议，包括代码示例和解释。"
            }
        }
    ]
}
```

### 3. 创意写作助手预设

```json
{
    "name": "创意写作助手",
    "description": "激发创作灵感的专业写作指导",
    "rules": [
        {
            "id": "writer-persona",
            "name": "写作者人格",
            "enabled": true,
            "type": "relative",
            "position": "after",
            "target": "system",
            "content": {
                "role": "system",
                "content": "你是一位经验丰富的创意写作导师，擅长故事构思、角色塑造和情节发展。"
            }
        },
        {
            "id": "writing-tips",
            "name": "写作技巧提醒",
            "enabled": true,
            "type": "depth",
            "depth": 4,
            "content": {
                "role": "system",
                "content": "记住：好的故事需要冲突、发展和解决。考虑添加感官描写来增强沉浸感。"
            }
        }
    ]
}
```

## 高级用法

### 条件注入

通过在 `content` 中使用占位符，可以实现条件注入：

```json
{
    "id": "conditional-tip",
    "name": "条件提示",
    "enabled": true,
    "type": "relative",
    "position": "before",
    "target": "last_user",
    "content": {
        "role": "system",
        "content": "如果用户的问题涉及{{topic}}，请提供更详细的解释。"
    }
}
```

### 多重注入

一个预设可以包含多个注入规则，实现复杂的上下文构建：

```json
{
    "rules": [
        {
            "id": "setup-context",
            "name": "建立上下文",
            "enabled": true,
            "type": "relative",
            "position": "before",
            "target": "system",
            "content": { "role": "system", "content": "这是一个持续的对话..." }
        },
        {
            "id": "memory-aid",
            "name": "记忆辅助",
            "enabled": true,
            "type": "depth",
            "depth": 5,
            "content": { "role": "system", "content": "回顾之前的讨论要点..." }
        },
        {
            "id": "response-guide",
            "name": "响应指导",
            "enabled": true,
            "type": "relative",
            "position": "after",
            "target": "last_user",
            "content": { "role": "system", "content": "请提供详细且有帮助的回答..." }
        }
    ]
}
```

## 最佳实践

1. **规则排序**: 相对注入按位置排序（before优先），深度注入按深度降序处理
2. **内容格式**: 确保注入内容的role和content格式正确
3. **测试验证**: 创建预设后进行充分测试，确保注入效果符合预期
4. **命名规范**: 使用清晰的规则名称，便于管理和维护
5. **性能考虑**: 避免创建过多的注入规则，影响对话流畅性

## 故障排除

### 常见问题

1. **预设不生效**: 检查触发器语法是否正确，格式为 `{{VCPTavern::预设名称}}`
2. **注入位置错误**: 验证 target 和 position 的组合是否符合预期
3. **内容格式错误**: 确保 content 对象包含正确的 role 和 content 字段
4. **文件权限问题**: 确保预设文件具有正确的读写权限

### 调试模式

启用调试模式可获得详细的处理日志：

```javascript
// 在插件配置中设置
{
    "DebugMode": true
}
```

调试信息将显示：
- 预设加载状态
- 触发器检测结果
- 注入处理过程
- 消息数量变化

## API 接口

VCPTavern 插件提供 RESTful API 用于预设管理：

- `GET /vcptavern/presets` - 获取所有预设名称
- `GET /vcptavern/presets/:name` - 获取特定预设详情
- `POST /vcptavern/presets/:name` - 保存/更新预设
- `DELETE /vcptavern/presets/:name` - 删除预设

这些 API 可以通过管理界面或直接调用来管理预设配置。

